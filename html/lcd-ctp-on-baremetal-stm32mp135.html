<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="author" content="Jakob Kastelic">
<meta name="date" content="19 Jan 2026">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Step-by-step bring-up of an RGB LCD and capacitive touch panel on a bare-metal STM32MP135 custom board, covering pin muxing, backlight PWM, I2C touch initialization, LTDC timing, and PLL clock configuration needed to achieve a stable display.">
<link rel="stylesheet" href="style.css">
<title>LCD/CTP on Bare-Metal STM32MP135</title>
</head>
<header class="site-banner">
<div class="logo">
<a href="http://embd.cc"><img src="favicon.ico" alt="logo">embd.cc</a>
</div>
<nav class="site-nav">
<a href="archive">Archive</a>
<a href="about">About</a>
</nav>
</header>
<body>
<div class="article">
<div class="article-topic">Embedded</div>
<h2>LCD/CTP on Bare-Metal STM32MP135</h2>
<div class="article-meta">Published 19 Jan 2026. Written by Jakob Kastelic.</div>
<p><img src="../images/lcd.jpg" alt="" /></p>
<p>In this writeup we’ll go through the steps needed to bring up the LCD/CTP
peripheral on the <a href="https://github.com/js216/stm32mp135_test_board">custom STM32MP135
board</a>.</p>
<h3 id="connections">Connections</h3>
<p>I am using the Rocktech <code>RK050HR01-CT</code> LCD display, connecting to the
<code>STM32MP135FAE</code> SoC, as follows:</p>
<table>
<thead>
<tr>
<th>LCD pin</th>
<th>LCD signal</th>
<th>SoC signal</th>
<th>SoC pin</th>
<th>Alt. Fn.</th>
</tr>
</thead>
<tbody>
<tr>
<td>1, 2</td>
<td><code>VLED+/-</code></td>
<td><code>PB15/TIM1_CH3N</code></td>
<td><code>B12</code></td>
<td>AF1</td>
</tr>
<tr>
<td>8</td>
<td><code>R3</code></td>
<td><code>PB12/LCD_R3</code></td>
<td><code>D9</code></td>
<td>AF13</td>
</tr>
<tr>
<td>9</td>
<td><code>R4</code></td>
<td><code>PE3/LCD_R4</code></td>
<td><code>D13</code></td>
<td>AF13</td>
</tr>
<tr>
<td>10</td>
<td><code>R5</code></td>
<td><code>PF5/LCD_R5</code></td>
<td><code>B2</code></td>
<td>AF14</td>
</tr>
<tr>
<td>11</td>
<td><code>R6</code></td>
<td><code>PF0/LCD_R6</code></td>
<td><code>C13</code></td>
<td>AF13</td>
</tr>
<tr>
<td>12</td>
<td><code>R7</code></td>
<td><code>PF6/LCD_R7</code></td>
<td><code>G2</code></td>
<td>AF13</td>
</tr>
<tr>
<td>15</td>
<td><code>G2</code></td>
<td><code>PF7/LCD_G2</code></td>
<td><code>M1</code></td>
<td>AF14</td>
</tr>
<tr>
<td>16</td>
<td><code>G3</code></td>
<td><code>PE6/LCD_G3</code></td>
<td><code>N1</code></td>
<td>AF14</td>
</tr>
<tr>
<td>17</td>
<td><code>G4</code></td>
<td><code>PG5/LCD_G4</code></td>
<td><code>F2</code></td>
<td>AF11</td>
</tr>
<tr>
<td>18</td>
<td><code>G5</code></td>
<td><code>PG0/LCD_G5</code></td>
<td><code>D7</code></td>
<td>AF14</td>
</tr>
<tr>
<td>19</td>
<td><code>G6</code></td>
<td><code>PA12/LCD_G6</code></td>
<td><code>E3</code></td>
<td>AF14</td>
</tr>
<tr>
<td>20</td>
<td><code>G7</code></td>
<td><code>PA15/LCD_G7</code></td>
<td><code>E6</code></td>
<td>AF11</td>
</tr>
<tr>
<td>24</td>
<td><code>B3</code></td>
<td><code>PG15/LCD_B3</code></td>
<td><code>G4</code></td>
<td>AF14</td>
</tr>
<tr>
<td>25</td>
<td><code>B4</code></td>
<td><code>PB2/LCD_B4</code></td>
<td><code>H4</code></td>
<td>AF14</td>
</tr>
<tr>
<td>26</td>
<td><code>B5</code></td>
<td><code>PH9/LCD_B5</code></td>
<td><code>A9</code></td>
<td>AF9</td>
</tr>
<tr>
<td>27</td>
<td><code>B6</code></td>
<td><code>PF4/LCD_B6</code></td>
<td><code>L2</code></td>
<td>AF13</td>
</tr>
<tr>
<td>28</td>
<td><code>B7</code></td>
<td><code>PB6/LCD_B7</code></td>
<td><code>C1</code></td>
<td>AF14</td>
</tr>
<tr>
<td>30</td>
<td><code>DCLK</code></td>
<td><code>PD9/LCD_CLK</code></td>
<td><code>E8</code></td>
<td>AF13</td>
</tr>
<tr>
<td>31</td>
<td><code>DISP</code></td>
<td><code>PG7</code></td>
<td><code>C9</code></td>
<td>—</td>
</tr>
<tr>
<td>32</td>
<td><code>HSYNC</code></td>
<td><code>PE1/LCD_HSYNC</code></td>
<td><code>B5</code></td>
<td>AF9</td>
</tr>
<tr>
<td>33</td>
<td><code>VSYNC</code></td>
<td><code>PE12/LCD_VSYNC</code></td>
<td><code>B4</code></td>
<td>AF9</td>
</tr>
<tr>
<td>34</td>
<td><code>DE</code></td>
<td><code>PG6/LCD_DE</code></td>
<td><code>A14</code></td>
<td>AF13</td>
</tr>
</tbody>
</table>
<h3 id="backlight">Backlight</h3>
<p>The easiest thing to check is the display backlight, since it’s just a single
GPIO pin to turn on/off, or a simple PWM to control the brightness via the duty
cycle.</p>
<p>In our case, the backlight pin is connected to <code>TIM1_CH3N</code>, which is alternate
function 1:</p>
<pre><code class="language-c"><div class="codehilite"><pre><span></span><span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">gpio</span><span class="p">;</span>
<span class="n">gpio</span><span class="p">.</span><span class="n">Pin</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PIN_15</span><span class="p">;</span>
<span class="n">gpio</span><span class="p">.</span><span class="n">Mode</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_MODE_AF_PP</span><span class="p">;</span>
<span class="n">gpio</span><span class="p">.</span><span class="n">Pull</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_NOPULL</span><span class="p">;</span>
<span class="n">gpio</span><span class="p">.</span><span class="n">Speed</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_SPEED_FREQ_LOW</span><span class="p">;</span>
<span class="n">gpio</span><span class="p">.</span><span class="n">Alternate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_AF1_TIM1</span><span class="p">;</span>
<span class="n">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gpio</span><span class="p">);</span>
</pre></div>
</code></pre>
<p>ChatGPT can write the PWM configuration:</p>
<pre><code class="language-c"><div class="codehilite"><pre><span></span><span class="n">__HAL_RCC_TIM1_CLK_ENABLE</span><span class="p">();</span>

<span class="n">htim1</span><span class="p">.</span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIM1</span><span class="p">;</span>
<span class="n">htim1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Prescaler</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mi">99U</span><span class="p">;</span>
<span class="n">htim1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">CounterMode</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_COUNTERMODE_UP</span><span class="p">;</span>
<span class="n">htim1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Period</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="mi">999U</span><span class="p">;</span>
<span class="n">htim1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">ClockDivision</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_CLOCKDIVISION_DIV1</span><span class="p">;</span>
<span class="n">htim1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">RepetitionCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">htim1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">AutoReloadPreload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_AUTORELOAD_PRELOAD_DISABLE</span><span class="p">;</span>
<span class="n">HAL_TIM_PWM_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">);</span>

<span class="n">TIM_OC_InitTypeDef</span><span class="w"> </span><span class="n">oc</span><span class="p">;</span>
<span class="n">oc</span><span class="p">.</span><span class="n">OCMode</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_OCMODE_PWM1</span><span class="p">;</span>
<span class="n">oc</span><span class="p">.</span><span class="n">Pulse</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mi">500U</span><span class="p">;</span>
<span class="n">oc</span><span class="p">.</span><span class="n">OCPolarity</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_OCPOLARITY_HIGH</span><span class="p">;</span>
<span class="n">oc</span><span class="p">.</span><span class="n">OCNPolarity</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_OCNPOLARITY_HIGH</span><span class="p">;</span>
<span class="n">oc</span><span class="p">.</span><span class="n">OCIdleState</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_OCIDLESTATE_RESET</span><span class="p">;</span>
<span class="n">oc</span><span class="p">.</span><span class="n">OCNIdleState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_OCNIDLESTATE_RESET</span><span class="p">;</span>
<span class="n">oc</span><span class="p">.</span><span class="n">OCFastMode</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_OCFAST_DISABLE</span><span class="p">;</span>

<span class="n">HAL_TIM_PWM_ConfigChannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oc</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_3</span><span class="p">);</span>
<span class="n">HAL_TIMEx_PWMN_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_3</span><span class="p">);</span>
<span class="n">htim1</span><span class="p">.</span><span class="n">Instance</span><span class="o">-&gt;</span><span class="n">BDTR</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">TIM_BDTR_MOE</span><span class="p">;</span>
</pre></div>
</code></pre>
<p>The only “tricky” part, or the part that AI got wrong, was that we have to use
<code>HAL_TIMEx_PWMN_Start()</code> instead of <code>HAL_TIM_PWM_Start()</code>, since we’re dealing
with the complementary output. With that fixed, the brightness pin showed a
clean square wave output, with duty cycle adjustable in units of <code>percent</code>:</p>
<pre><code class="language-c"><div class="codehilite"><pre><span></span><span class="n">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_3</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="p">(</span><span class="n">htim1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Period</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1U</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">percent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100U</span><span class="p">);</span>
</pre></div>
</code></pre>
<p>Unfortunately, the PCB reversed all pins and the connector is single sided, so
we cannot directly check if the above works on the actual display or not.
Nonetheless, we can see a nice 2.088893 kHz square wave with 50 duty cycle, and
we can tune it from 0% to 100%.</p>
<h3 id="ctp-connections">CTP connections</h3>
<p>The Rocktech <code>RK050HR01-CT</code> LCD display includes a capacitive touchpad (CTP),
connecting to the <code>STM32MP135FAE</code> SoC, as follows:</p>
<table>
<thead>
<tr>
<th>CPT pin</th>
<th>CPT signal</th>
<th>SoC signal</th>
<th>SoC pin</th>
<th>Alt. Fn.</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td><code>SCL</code></td>
<td><code>PH13/I2C5_SCL</code></td>
<td><code>A10</code></td>
<td>AF4</td>
</tr>
<tr>
<td>8</td>
<td><code>SDA</code></td>
<td><code>PF3/I2C5_SDA</code></td>
<td><code>B10</code></td>
<td>AF4</td>
</tr>
<tr>
<td>4</td>
<td><code>RST</code></td>
<td><code>PB7</code></td>
<td><code>A4</code></td>
<td>—</td>
</tr>
<tr>
<td>5</td>
<td><code>INT</code></td>
<td><code>PH12</code></td>
<td><code>C2</code></td>
<td>—</td>
</tr>
</tbody>
</table>
<p>Luckily the 6-pin CTP connector, albeit wired in reverse, has contacts on both
top and bottom sides, so we can simply flip the ribbon cable. With entirely
usual I2C configuration it simply works. Check out the final result
<a href="https://github.com/js216/stm32mp135-bootloader/blob/main/src/ctp.c">here</a></p>
<p>My GT911 driver is just under 300 lines of code; it’s very interesting that it
takes ST almost 3,000 (yes, it has more features … Whatever, I don’t need
them!)</p>
<pre><code class="language-sh"><div class="codehilite"><pre><span></span>stm32cubemp13-v1-2-0/STM32Cube_FW_MP13_V1.2.0/Drivers/BSP/Components/gt911$<span class="w"> </span>cloc<span class="w"> </span>.
<span class="w">      </span><span class="m">12</span><span class="w"> </span>text<span class="w"> </span>files.
<span class="w">      </span><span class="m">12</span><span class="w"> </span>unique<span class="w"> </span>files.
<span class="w">       </span><span class="m">1</span><span class="w"> </span>file<span class="w"> </span>ignored.

github.com/AlDanial/cloc<span class="w"> </span>v<span class="w"> </span><span class="m">1</span>.90<span class="w">  </span><span class="nv">T</span><span class="o">=</span><span class="m">0</span>.10<span class="w"> </span>s<span class="w"> </span><span class="o">(</span><span class="m">109</span>.2<span class="w"> </span>files/s,<span class="w"> </span><span class="m">48189</span>.3<span class="w"> </span>lines/s<span class="o">)</span>
-------------------------------------------------------------------------------
Language<span class="w">                     </span>files<span class="w">          </span>blank<span class="w">        </span>comment<span class="w">           </span>code
-------------------------------------------------------------------------------
CSS<span class="w">                              </span><span class="m">1</span><span class="w">            </span><span class="m">209</span><span class="w">             </span><span class="m">56</span><span class="w">           </span><span class="m">1446</span>
C<span class="w">                                </span><span class="m">2</span><span class="w">            </span><span class="m">223</span><span class="w">            </span><span class="m">636</span><span class="w">            </span><span class="m">940</span>
C/C++<span class="w"> </span>Header<span class="w">                     </span><span class="m">3</span><span class="w">            </span><span class="m">159</span><span class="w">            </span><span class="m">614</span><span class="w">            </span><span class="m">421</span>
Markdown<span class="w">                         </span><span class="m">2</span><span class="w">             </span><span class="m">24</span><span class="w">              </span><span class="m">0</span><span class="w">             </span><span class="m">62</span>
HTML<span class="w">                             </span><span class="m">1</span><span class="w">              </span><span class="m">0</span><span class="w">              </span><span class="m">3</span><span class="w">             </span><span class="m">56</span>
SVG<span class="w">                              </span><span class="m">2</span><span class="w">              </span><span class="m">0</span><span class="w">              </span><span class="m">0</span><span class="w">              </span><span class="m">4</span>
-------------------------------------------------------------------------------
SUM:<span class="w">                            </span><span class="m">11</span><span class="w">            </span><span class="m">615</span><span class="w">           </span><span class="m">1309</span><span class="w">           </span><span class="m">2929</span>
-------------------------------------------------------------------------------
</pre></div>
</code></pre>
<p>My example code prints out the touch coordinates whenever the touch interrupt
fires. Not much more to do, since the CTP will be used within some application
which will implement more advanced features. The only reason to include this in
the bootloader code is to verify that the I2C connection works.</p>
<h3 id="lcd">LCD</h3>
<p>The custom board is wired backwards, but we can verify that the code is correct
on the eval board. Besides forgetting to turn the <code>LCD_DISP</code> signal on, it all
worked. You set up a framebuffer somewhere (I just used the beginning of the DDR
memory), and write bits there, and magically the picture appears on the display.
For example, to display solid colors:</p>
<pre><code class="language-c"><div class="codehilite"><pre><span></span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">lcd_fb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">DRAM_MEM_BASE</span><span class="p">;</span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">RK043FN48H_HEIGHT</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">RK043FN48H_WIDTH</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">p</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">RK043FN48H_WIDTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3U</span><span class="p">;</span>
<span class="w">      </span><span class="n">lcd_fb</span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"> </span><span class="c1">// blue</span>
<span class="w">      </span><span class="n">lcd_fb</span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">;</span><span class="w"> </span><span class="c1">// green</span>
<span class="w">      </span><span class="n">lcd_fb</span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"> </span><span class="c1">// red</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* make sure CPU writes reach DDR before LTDC reads */</span>
<span class="n">L1C_CleanDCacheAll</span><span class="p">();</span>
</pre></div>
</code></pre>
<h3 id="40-pin-adapter">40-pin adapter</h3>
<p>Making use of an adapter from the 40-pin FFC ribbon cable to jumper wires, we
can verify the signals also on the custom board. We see:</p>
<pre><code>R[3:7] signal when screen set to red, otherwise low
G[3:7] signal when screen set to green, otherwise low
B[3:7] signal when screen set to blue, otherwise low
DCLK:  10 MHz
DISP:  3.3V
HSYNC: 17.6688 kHz, 92.76% duty cycle
VSYNC: 61.779 Hz, 96.5% duty cycle
DE:    16.7--16.9 kHz, ~84% duty cycle
</code></pre>
<p>We can see the brightness change when adjusting the duty cycle of the backlight.</p>
<p>Left ~2/3 of the screen shows white vertical stripes, the exact pattern of these
stripes depending on what “color” the screen is set to. The right ~1/3 of the
screen is black. This is to be expected, since we’re using the same settings for
both displays. Here’s the settings which work fine on the eval board:</p>
<pre><code class="language-c"><div class="codehilite"><pre><span></span><span class="cp">#define LCD_WIDTH  480U </span><span class="c1">// LCD PIXEL WIDTH</span>
<span class="cp">#define LCD_HEIGHT 272U </span><span class="c1">// LCD PIXEL HEIGHT</span>
<span class="cp">#define LCD_HSYNC  41U  </span><span class="c1">// Horizontal synchronization</span>
<span class="cp">#define LCD_HBP    13U  </span><span class="c1">// Horizontal back porch</span>
<span class="cp">#define LCD_HFP    32U  </span><span class="c1">// Horizontal front porch</span>
<span class="cp">#define LCD_VSYNC  10U  </span><span class="c1">// Vertical synchronization</span>
<span class="cp">#define LCD_VBP    2U   </span><span class="c1">// Vertical back porch</span>
<span class="cp">#define LCD_VFP    2U   </span><span class="c1">// Vertical front porch</span>
</pre></div>
</code></pre>
<p>The custom board uses a different display, so let’s try different settings:</p>
<pre><code class="language-c"><div class="codehilite"><pre><span></span><span class="cp">#define LCD_WIDTH   800U</span>
<span class="cp">#define LCD_HEIGHT  480U</span>
<span class="cp">#define LCD_HSYNC   1U</span>
<span class="cp">#define LCD_HBP     8U</span>
<span class="cp">#define LCD_HFP     8U</span>
<span class="cp">#define LCD_VSYNC   1U</span>
<span class="cp">#define LCD_VBP     16U</span>
<span class="cp">#define LCD_VFP     16U</span>
</pre></div>
</code></pre>
<p>Now the screen is totally white, regardless of which color we send it. We notice
that the LCD datasheet specifies a minimum clock frequency of 10 MHz. Note that
on the STM32MP135, the LCD clock comes from <code>PLL4Q</code>. Raising the <code>DCLK</code> to 24
MHz, the screen works! We get to see all the colors. The <code>PLL4</code> configuration
that works for me is</p>
<pre><code class="language-c"><div class="codehilite"><pre><span></span><span class="n">rcc_oscinitstructure</span><span class="p">.</span><span class="n">PLL4</span><span class="p">.</span><span class="n">PLLState</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_PLL_ON</span><span class="p">;</span>
<span class="n">rcc_oscinitstructure</span><span class="p">.</span><span class="n">PLL4</span><span class="p">.</span><span class="n">PLLSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_PLL4SOURCE_HSE</span><span class="p">;</span>
<span class="n">rcc_oscinitstructure</span><span class="p">.</span><span class="n">PLL4</span><span class="p">.</span><span class="n">PLLM</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="n">rcc_oscinitstructure</span><span class="p">.</span><span class="n">PLL4</span><span class="p">.</span><span class="n">PLLN</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
<span class="n">rcc_oscinitstructure</span><span class="p">.</span><span class="n">PLL4</span><span class="p">.</span><span class="n">PLLP</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<span class="n">rcc_oscinitstructure</span><span class="p">.</span><span class="n">PLL4</span><span class="p">.</span><span class="n">PLLQ</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mi">25</span><span class="p">;</span>
<span class="n">rcc_oscinitstructure</span><span class="p">.</span><span class="n">PLL4</span><span class="p">.</span><span class="n">PLLR</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<span class="n">rcc_oscinitstructure</span><span class="p">.</span><span class="n">PLL4</span><span class="p">.</span><span class="n">PLLRGE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_PLL4IFRANGE_1</span><span class="p">;</span>
<span class="n">rcc_oscinitstructure</span><span class="p">.</span><span class="n">PLL4</span><span class="p">.</span><span class="n">PLLFRACV</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">rcc_oscinitstructure</span><span class="p">.</span><span class="n">PLL4</span><span class="p">.</span><span class="n">PLLMODE</span><span class="w">   </span><span class="o">=</span>
<span class="n">RCC_PLL_INTEGER</span><span class="p">;</span>
</pre></div>
</code></pre>
<h3 id="usb-stops-working">USB stops working</h3>
<p>Unfortunately, just as the LCD becomes configured correctly and is able to
display the solid red, green, or blue colors, I noticed that the USB MSC
interface disappeared. If I comment out the LCD init code, so it does not run,
then USB comes back. How could they possibly interact?</p>
<p>Even more interesting, the USB stops working only if <em>both</em> of the following
functions are called: <code>lcd_backlight_init()</code>, which configures the backlight
brightness PWM, and <code>lcd_panel_init()</code>, which does panel timing and pin
configuration.</p>
<p>As it turns out, my 3.3V supply was set with a 0.1A current limit. Having
enabled so many peripherals, the current draw can be a bit higher now.
Increasing the current limit up to 0.2A, and everything works fine. In the
steady state, after init is complete, the board draws just under 0.1A from the
3.3V supply. (For the record, I’m drawing about 0.26A from the combined 1.25V /
1.35V supply.)</p>
<h3 id="conclusion">Conclusion</h3>
<p>Bringing up the LCD on the custom board ultimately came down to matching the
panel’s exact timing and, critically, running the pixel clock within the range
specified by the datasheet. Once the LTDC geometry and <code>PLL4Q</code> frequency were
correct, the display worked immediately, confirming that the signal wiring and
framebuffer logic were sound.</p>

</div>

<footer class="license-footer">
<p>Content licensed under
<a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.
</p>
</footer>

</body>
</html>
